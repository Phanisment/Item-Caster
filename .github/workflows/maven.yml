name: Java CI with Maven
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
      
    - name: Build with Maven
      id: build_maven
      run: |
        mvn -B package --file pom.xml 2>&1 | tee maven_build.log
      continue-on-error: true

    - name: Upload Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: artifact
        path: dev/libs/*.jar

    - name: Send Error to Discord
      if: failure()
      run: |
        LOG_OUTPUT=$(tail -n 50 maven_build.log)
        LOG_OUTPUT_ESCAPED=$(echo "$LOG_OUTPUT" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')
        curl -H "Content-Type: application/json" \
        -d "{\"content\": \"Build failed for repository: ${{ github.repository }} at commit: ${{ github.sha }}.\\n\\nLast 50 lines of log:\\n```$LOG_OUTPUT_ESCAPED```\"}" \
        ${{ secrets.WEBHOOK }}
